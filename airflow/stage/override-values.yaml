# This file contains only the custom overrides for your stage-2.9.2 environment,
# generated by comparing your custom values against the chart's defaults.
# Use this as the 'valueFiles' source in your ArgoCD Application definition.

# -------------------------------------------------------------------------
# 1. CORE AIRFLOW & EXECUTOR
# -------------------------------------------------------------------------
executor: CeleryExecutor

# Use a custom Airflow image from your ECR
images:
  airflow:
    repository: 257676781382.dkr.ecr.us-east-2.amazonaws.com/hsarch-airflow
    # tag is still 2.9.2, so no need to override the tag

# Your Fernet Key (REDACTED for security)
fernetKey: 7T512UXSSmBOkpWimFHIVb8jK6lfmSAvx4mO6Arehnc=

# -------------------------------------------------------------------------
# 2. AIRFLOW CONFIGURATION (airflow.cfg)
# -------------------------------------------------------------------------
config:
  # SMTP configuration for email alerts
  email:
    email_backend: airflow.utils.email.send_email_smtp
  smtp:
    smtp_host: smtp2010.searshc.com
    smtp_mail_from: airflow-notifications@transformco.com
    smtp_port: "25"
    smtp_ssl: "False"
    smtp_starttls: "False"
  # Webserver configuration
  webserver:
    expose_config: "True" # Exposing config is usually a non-default setting

# -------------------------------------------------------------------------
# 3. DAGS & PERSISTENCE
# -------------------------------------------------------------------------
dags:
  gitSync:
    enabled: true # Enable Git Sync for DAGs
    branch: stage-2.9.2 # Your custom branch
    repo: https://github.com/apache/airflow.git
    subPath: tests/dags
  
  persistence:
    enabled: true
    accessMode: ReadWriteMany # Changed from default ReadWriteOnce
    existingClaim: airflow-dags
    size: 20Gi # Increased volume size
    storageClassName: fsx-sc # Custom Storage Class for DAGs

logs:
  persistence:
    enabled: true
    existingClaim: airflow-logs
    size: 20Gi
    storageClassName: fsx-sc # Custom Storage Class for Logs

# -------------------------------------------------------------------------
# 4. DATABASE / MESSAGE BROKER
# -------------------------------------------------------------------------
# Note: Since you are likely using `AIRFLOW__CORE__SQL_ALCHEMY_CONN` environment
# variable/secret (indicated by enableBuiltInSecretEnvVars), these values
# primarily serve for the `db migrate` job but should be consistent.
data:
  metadataConnection:
    db: airflow
    host: shs-airflow-stage.stage.nextgen.shs.com
    pass: zN7_-5PrpgT0kI3zVFLb
    user: airflow_usr

# Enable Redis (required for CeleryExecutor)
redis:
  enabled: true
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: eks.amazonaws.com/nodegroup
            operator: In
            values:
            - airflow # Affinity to the standard 'airflow' node group

# Enable PgBouncer
pgbouncer:
  enabled: true
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: eks.amazonaws.com/nodegroup
            operator: In
            values:
            - airflow # Affinity to the standard 'airflow' node group
  auth:
    # Setting PGBouncer credentials (REDACTED)
    password: ""
    postgresPassword: postgres
    username: ""
    postgresUsername: ""

# -------------------------------------------------------------------------
# 5. AIRFLOW COMPONENTS (RESOURCES & NODE AFFINITY)
# -------------------------------------------------------------------------

# Disabling the default Webserver user creation
webserver:
  defaultUser:
    enabled: false
  # Webserver Service Exposure
  service:
    type: LoadBalancer
    loadBalancerSourceRanges: []
   
  # Resource Overrides
  resources:
    limits:
      cpu: 1
      memory: 4Gi
    requests:
      cpu: 500m
      memory: 2Gi
  
  # Node Affinity
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: eks.amazonaws.com/nodegroup
            operator: In
            values:
            - airflow

# Scheduler
scheduler:
  # Resource Overrides
  resources:
    limits:
      cpu: 2
      memory: 6Gi
    requests:
      cpu: 1
      memory: 4Gi
  # Node Affinity
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: eks.amazonaws.com/nodegroup
            operator: In
            values:
            - airflow-jobs

# Workers
workers:
  # Resource Overrides
  resources:
    limits:
      cpu: 1
      memory: 4Gi
    requests:
      cpu: 500m
      memory: 2Gi
  # Node Affinity
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: eks.amazonaws.com/nodegroup
            operator: In
            values:
            - airflow

# Triggerer
triggerer:
  # Resource Overrides
  resources:
    limits:
      cpu: 2
      memory: 6Gi
    requests:
      cpu: 1
      memory: 4Gi
  # Node Affinity
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: eks.amazonaws.com/nodegroup
            operator: In
            values:
            - airflow-jobs

# DAG Processor (Enabled and configured)
dagProcessor:
  enabled: true
  safeToEvict: false # Changed from default 'true'
  # Resource Overrides
  resources:
    limits:
      cpu: 1500m
      memory: 2Gi
    requests:
      cpu: 1
      memory: 1Gi
  # Node Affinity
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: eks.amazonaws.com/nodegroup
            operator: In
            values:
            - airflow-jobs
  logGroomerSidecar:
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 128Mi

# Database Migration Job
migrateDatabaseJob:
  # Resource Overrides
  resources:
    limits:
      cpu: 1
      memory: 1Gi
    requests:
      cpu: 500m
      memory: 512Mi
  # Node Affinity
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: eks.amazonaws.com/nodegroup
            operator: In
            values:
            - airflow-jobs